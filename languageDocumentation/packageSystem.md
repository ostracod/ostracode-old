
# Package System

This page documents the package system in OstraCode.

## Principles of Usage

A "package" is a directory containing an end-user application, or a library which may be imported by other packages. Each package must use the directory structure as documented on this page.

Each OstraCode file in a package may run on one or more of the target platforms below:

* `generic` represents a runtime environment which only includes plain ECMAScript features.
* `node` represents the Node.js runtime environment.
* `browser` represents a web browser environment.

OstraCode packages may be distributed using Node.js package managers such as NPM. OstraCode packages are installed into the `node_modules` directory of their dependents. OstraCode packages contain a `package.json` file which specifies the exports and dependencies of the package.

All packages must be distributed with source code, because dependents may require source code at compile-time. Packages may include compiled JavaScript, or may perform compilation during a `postinstall` step in `package.json`.

The steps below prepare a package to be run:

1. Generate `package.json` based on `ostraConfig.json`.
1. Install dependencies based on `package.json`.
1. Compile OstraCode into JavaScript.

Each JavaScript file compiled from OstraCode is an ECMAScript module. As a result, OstraCode is only compatible with Node.js 13 and higher, or most browsers updated after 2016.

## Directory Structure

Each package has the directory structure below:

* `ostraConfig.json` (file) stores package metadata and compilation rules.
* `package.json` (file) is consumed by Node.js and package managers. `package.json` is derived from `ostraConfig.json`.
* `node_modules` (directory) stores dependency packages which may be written in OstraCode or JavaScript. `node_modules` is set up by a Node.js package manager.
* `src` (directory) stores OstraCode source files. Each OstraCode file has the extension `.ostc`.
* `build` (directory) stores JavaScript files compiled from corresponding OstraCode files with the same relative path in the `src` directory. Each JavaScript file has the extension `.js`.
* `support` (directory) stores artifacts generated by the compiler which are required for the package to run.
* `foreign` (directory) stores JavaScript files which are not compiled from OstraCode, but may be imported by OstraCode with the `foreign` attribute statement.
* `data` (directory) stores general-purpose data used by the package during compilation or runtime.

## OstraConfig File

The content of `ostraConfig.json` has the following type:

```
dictT [fields [
    name (strT)
    version (strT)
    ostraCodeVersion (strT)
    rules (dictT [
        fieldType (dictT [fields [
            srcPaths (listT [elemType (strT)]) [optional]
            dependencies (dictT [fieldType (strT)]) [optional]
            constants (dictT) [optional]
            platforms (listT [elemType (strT)]) [optional]
            includeRules (listT [elemType (strT)]) [optional]
        ]])
    ])
    exports (dictT [fieldType (strT)]) [optional]
]]
```

* `name` is the name of the package.
* `version` is the semantic version number of the package.
* `ostraCodeVersion` is the semantic version number of OstraCode with which the package is compatible.
* `rules` is a map from name to compilation rule. The rule named `main` is used to build the package for distribution. Other rules may be defined for use-cases such as automated tests and debugging.
    * `srcPaths` is a list of paths relative to the `src` directory which will be compiled from OstraCode to JavaScript.
    * `dependencies` is a map from dependency package name to semantic version number.
    * `constants` is a set of key-value pairs which will be added to the `configConstants` dictionary. OstraCode source files may read the contents of `configConstants`.
    * `platforms` is the list of platform names on which compiled JavaScript can run. If `platforms` is excluded, then platform names will be inherited from any parent which includes the rule.
    * `includeRules` is the list of rule names which will be evaluated after the current rule.
* `exports` is a map from export name to source file path. Modules specified by the `exports` field may be imported by other packages using the `importPackage` statement. When `importPackage` does not specify an export name, the export with the name `default` will be used.


